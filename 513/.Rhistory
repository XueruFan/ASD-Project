rm(list=ls())
packages <- c("ggplot2", "ggseg", "ggridges", "tidyr", "Cairo")
# sapply(packages, install.packages, character.only = TRUE)
sapply(packages, require, character.only = TRUE)
# define filefolder
abideDir <- 'E:/PhDproject/ABIDE'
dataDir <- file.path(abideDir, "Preprocessed")
resDir <- file.path(abideDir, "Analysis/Cluster/Spect513")
plotDir <- file.path(abideDir, "Plot/Density")
resdate <- "240315"
newDate <- "240610"
abide_centile <- read.csv(file.path(dataDir, paste0("abide_All_centile_513_", resdate, ".csv")))
asd_centile <- subset(abide_centile, dx == "ASD" & sex == "Male")
rm(list=ls())
packages <- c("ggplot2", "ggseg", "ggridges", "tidyr", "do", "dplyr", "Cairo", "openxlsx")
# sapply(packages, install.packages, character.only = TRUE)
sapply(packages, require, character.only = TRUE)
# abideDir <- '/Volumes/Xueru/PhDproject/ABIDE' # MAC
abideDir <- 'E:/PhDproject/ABIDE' # Windows
resDir <- file.path(abideDir, "Analysis/Cluster/Spect513")
plotDir <- file.path(abideDir, "Plot/Cluster/Spect513")
resDate <- "240315"
newDate <- "240610"
name <- paste0("Cluster_", newDate, ".csv")
cluster_result <- read.csv(file.path(resDir, name))
######################### Part 4: Project extram percentage on the brain ###########################
# 34个脑区的异常流行率, 对于每个脑区来说有多少人的体积常模分属于极端值（位于thr以外，这里thr取5%）
group1 <- (subset(cluster_result, clusterID == "1"))[, -1:-9]
group2 <- (subset(cluster_result, clusterID == "2"))[, -1:-9]
label_map <- c("额上回" = "Superior frontal",
"额中回喙部" = "Rostral middle frontal",
"额中回尾部" = "Caudal middle frontal",
"额下回盖部" = "Pars opercularis",
"额下回三角部" = "Pars triangularis",
"额下回眶部" = "Pars orbitalis",
"额极" = "Frontal pole",
"外侧眶额" = "Lateral orbital frontal",
"内侧眶额" = "Medial orbital frontal",
"前扣带喙部" = "Rostral anterior cingulate",
"前扣带尾部" = "Caudal anterior cingulate",
"中央前回" = "Precentral",
"中央旁小叶" = "Paracentral",
"中央后回" = "Postcentral",
"缘上回" = "Supramarginal",
"后扣带" = "Posterior cingulate",
"扣带回峡部" = "Isthmus cingulate",
"楔前叶" = "Precuneus",
"顶上皮层" = "Superior ",
"顶下皮层" = "Inferior parietal",
"颞横皮层" = "Transverse temporal",
"颞上沟后侧" = "Banks superior temporal",
"颞上回" = "Superior temporal",
"颞中回" = "Middle temporal",
"颞下回" = "Inferior temporal",
"梭状回" = "Fusiform",
"海马旁回" = "Parahippocampal",
"内嗅皮层" = "Entorhinal",
"颞极" = "Temporal pole",
"外侧枕叶" = "Lateral occipital",
"舌回" = "Lingual",
"距状沟周围皮层" = "Pericalcarine",
"楔叶皮层" = "Cuneus",
"脑岛" = "Insula")
label_map_df <- data.frame(
EnglishLabel = names(label_map),
fulllabel = as.character(label_map),  # 确保中文标签是字符类型
stringsAsFactors = FALSE
)
label <- c("superiorfrontal", "rostralmiddlefrontal", "caudalmiddlefrontal",
"parsopercularis", "parstriangularis", "parsorbitalis", "frontalpole",
"lateralorbitofrontal", "medialorbitofrontal",
"rostralanteriorcingulate", "caudalanteriorcingulate",
"precentral", "paracentral", "postcentral",
"supramarginal", "posteriorcingulate", "isthmuscingulate",
"precuneus", "superiorparietal", "inferiorparietal",
"transversetemporal", "bankssts",
"superiortemporal", "middletemporal", "inferiortemporal",
"fusiform", "parahippocampal", "entorhinal", "temporalpole",
"lateraloccipital", "lingual", "pericalcarine", "cuneus",
"insula")
label_map_df <- cbind(label_map_df, label)
###########
thr <- 0.025
# cluster 1
# 小于
abno <- apply(group1 < thr, 2, function(x) sum(x) / length(x) * 100)
label <- names(abno)
abno_g1 <- data.frame(label)
abno_g1$perc <- as.numeric(abno)
abno_g1 <- merge(abno_g1, label_map_df, by = "label")
# 保存一个排序
abno_g1_sorted <- abno_g1 %>% arrange(desc(perc))
############  cluster 2
# 大于95% !!!
abno <- apply(group2 >= (1-thr), 2, function(x) sum(x) / length(x) * 100)
label <- names(abno)
abno_g2 <- data.frame(label)
abno_g2$perc <- as.numeric(abno)
abno_g2 <- merge(abno_g2, label_map_df, by = "label")
abno_g2_sorted <- abno_g2 %>% arrange(desc(perc))
# 画脑图
abno_g2$label <- as.character(paste0("lh_", abno_g2$label))
View(abno_g2)
ggseg(.data = abno_g2, mapping = aes(fill = perc), color = "black", atlas = dk,
position = "stacked", hemisphere = "left", size = 1.2) +
theme_void() +
theme(legend.title = element_blank(), legend.position = "bottom",
legend.key.width = unit(1, "cm")) +
scale_fill_gradient(low = "white", high = "#d26b66", limits = c(0, 7),
# breaks = seq(0, 18, by=6),  # 自定义区间
breaks = seq(0, 7, by=3.5),  # 自定义区间
labels = c("0", "3.5%", "7")) +
# scale_fill_viridis_c(option = "inferno", limits = c(0, 18),  # 设置上下限
#                      breaks = seq(0,18, by=6),  # 自定义区间
#                      labels = c("0", "6", "12", "18")) +
guides(fill = guide_colourbar(frame.colour = "black", frame.linewidth = 1, ticks = FALSE))
ggseg(.data = abno_g2, mapping = aes(fill = perc), color = "black", atlas = dk,
position = "stacked", hemisphere = "left", size = 1.2) +
theme_void() +
theme(legend.title = element_blank(), legend.position = "bottom",
legend.key.width = unit(1, "cm")) +
scale_fill_gradient(low = "white", high = "#d26b66", limits = c(0, 7),
# breaks = seq(0, 18, by=6),  # 自定义区间
breaks = c(0, 2, 4, 6),  # 自定义区间
labels = c("0", "2%", "4%", "6%")) +
# scale_fill_viridis_c(option = "inferno", limits = c(0, 18),  # 设置上下限
#                      breaks = seq(0,18, by=6),  # 自定义区间
#                      labels = c("0", "6", "12", "18")) +
guides(fill = guide_colourbar(frame.colour = "black", frame.linewidth = 1, ticks = FALSE))
name <- paste0("Cluster_2_Ab975brain_V1_", newDate, ".png")
ggsave(file.path(plotDir, name), width = 7.8, height = 3, units = "in", dpi = 500)
